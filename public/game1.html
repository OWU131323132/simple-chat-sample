<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ãƒ‘ãƒ¯ãƒ¼ãƒ»ã‚¹ãƒˆãƒƒãƒ— ãƒ¬ãƒ¼ã‚¹ | PCç”»é¢</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.8.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <style>
      #score-list {
        list-style-type: none;
        padding-left: 0;
      }
      .finished {
        color: green;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <h1>ãƒ‘ãƒ¯ãƒ¼ãƒ»ã‚¹ãƒˆãƒƒãƒ— ãƒ¬ãƒ¼ã‚¹ | PCç”»é¢</h1>
    <div>
      <div>ã‚ãªãŸã®ID: <span id="myid"></span></div>
      <button id="connect">æ¥ç¶šé–‹å§‹</button>
      <div>ã‚¹ãƒãƒ›ã§smart.htmlã‚’é–‹ãã€æ¥ç¶šå¾Œã«ç¸¦ã«æŒ¯ã£ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚</div>
    </div>
    
    <div id="ranking" style="margin-top: 20px;">
      <h2>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <ul id="score-list">
        <li>ã‚¹ãƒãƒ›ã‚’ç¸¦ã«æŒ¯ã£ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼</li>
      </ul>
    </div>
    
    <script>
      let socket = io.connect();

      let myid = sessionStorage.getItem('clientId');
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem('clientId', myid);
      }
      
      document.querySelector("#myid").innerHTML = myid.substring(0, 6);
      console.log("ã‚ãªãŸã®ID: ", myid);

      let btn = document.querySelector("#connect");
      
      // æ¥ç¶šãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ ã«å‚åŠ 
      btn.addEventListener("click", function () {
        socket.emit("join", "game");
        
        // æ¥ç¶šIDã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€šçŸ¥ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã®ãŸã‚ï¼‰
        socket.emit('user connected', myid); 
        btn.remove();
      });

      // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã®ãŸã‚ã®å¤‰æ•° ---
      let players = {}; // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’ä¿æŒ
      const GAME_AREA_WIDTH = 500;
      const GAME_AREA_HEIGHT = 400; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®é«˜ã•ã‚’è¨­å®š
      const START_X = 50;
      const GOAL_X = 450;
      
      // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°ã‚’å—ä¿¡
      socket.on("game_update", function (data) {
          players = data;
          updateRankingDisplay();
      });

      // ã‚´ãƒ¼ãƒ«é€šçŸ¥ã‚’å—ä¿¡
      socket.on("game_finished", function (data) {
          if (data.id === myid) {
              alert(`ğŸ‰ ã‚ãªãŸãŒã‚´ãƒ¼ãƒ«ï¼ ã‚¿ã‚¤ãƒ : ${data.time}ç§’`);
          } else {
              console.log(`ğŸ‰ ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${data.id.substring(0, 6)} ãŒã‚´ãƒ¼ãƒ«ï¼ ã‚¿ã‚¤ãƒ : ${data.time}ç§’`);
          }
      });
      
      // æ¥ç¶šå‡¦ç† (IDè¡¨ç¤ºãªã©ã®ãŸã‚)
      socket.on('welcome', (id) => {
        // å‡¦ç†ä¸è¦
      });
      
      socket.on('player_list', (initialPlayers) => {
        players = initialPlayers;
        updateRankingDisplay();
      });


      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      function updateRankingDisplay() {
          const scoreList = document.querySelector("#score-list");
          scoreList.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
          
          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ ã§ã‚½ãƒ¼ãƒˆ
          const sortedPlayers = Object.values(players)
              .sort((a, b) => {
                  // ã‚´ãƒ¼ãƒ«ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å„ªå…ˆ (Infinityã‚’è€ƒæ…®)
                  if (a.isFinished && !b.isFinished) return -1;
                  if (!a.isFinished && b.isFinished) return 1;
                  // ã‚´ãƒ¼ãƒ«æ¸ˆã¿ãªã‚‰ã‚¿ã‚¤ãƒ ã§ã‚½ãƒ¼ãƒˆ
                  if (a.isFinished && b.isFinished) return a.bestTime - b.bestTime;
                  // æœªã‚´ãƒ¼ãƒ«ãªã‚‰IDã§ã‚½ãƒ¼ãƒˆï¼ˆé©å½“ï¼‰
                  return a.id.localeCompare(b.id);
              });

          // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
          sortedPlayers.forEach((p, index) => {
              const status = (p.id === myid) ? ' (ã‚ãªãŸ)' : '';
              const item = document.createElement('li');
              
              if (p.isFinished) {
                  const timeStr = p.bestTime.toFixed(2);
                  item.classList.add('finished');
                  item.textContent = `#${index + 1}: ${p.id.substring(0, 6)} ${status} - ${timeStr}ç§’`;
              } else {
                  // ãƒ¬ãƒ¼ã‚¹ä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
                  const v_text = p.startTime ? ` (é€Ÿåº¦: ${p.v.toFixed(1)})` : '';
                  item.textContent = `${p.id.substring(0, 6)} ${status} - ãƒ¬ãƒ¼ã‚¹å‰${v_text}`;
              }
              scoreList.appendChild(item);
          });
      }

      function setup() {
          createCanvas(GAME_AREA_WIDTH, GAME_AREA_HEIGHT);
          background(200);
          rectMode(CENTER);
          noStroke();
      }

      function draw() {
          background(220); // èƒŒæ™¯ã‚’è–„ã„ã‚°ãƒ¬ãƒ¼ã«
          
          // --- ã‚³ãƒ¼ã‚¹æç”» ---
          // ã‚´ãƒ¼ãƒ«ãƒ©ã‚¤ãƒ³ã‚’æç”»
          stroke(255, 0, 0); // èµ¤è‰²
          strokeWeight(4);
          line(GOAL_X, 0, GOAL_X, GAME_AREA_HEIGHT);
          
          // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã‚’æç”»
          stroke(0, 200, 0); // ç·‘è‰²
          strokeWeight(4);
          line(START_X, 0, START_X, GAME_AREA_HEIGHT);
          
          noStroke();
          
          // --- å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒãƒ¼ã‚’æç”» ---
          const playerIds = Object.keys(players);
          playerIds.forEach((id, index) => {
              const player = players[id];
              const playerX = player.x;
              // æç”»Yåº§æ¨™ã‚’å‡ç­‰ã«ãšã‚‰ã™
              const playerY = GAME_AREA_HEIGHT * (index + 1) / (playerIds.length + 1); 
              
              
              // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®è‰²è¨­å®šï¼ˆIDã‹ã‚‰ç”Ÿæˆï¼‰
              const color = getColorFromId(id);
              if (player.isFinished) {
                 fill(color[0], color[1], color[2], 150); // ã‚´ãƒ¼ãƒ«ã—ãŸã‚‰è–„ã„è‰²
              } else {
                 fill(color[0], color[1], color[2]);
              }
              
              // ãƒãƒ¼ï¼ˆè‡ªæ©Ÿï¼‰ã®æç”»
              rect(playerX, playerY, 40, 30);
              
              // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’è¡¨ç¤º
              fill(0);
              textSize(12);
              textAlign(CENTER, CENTER);
              text(player.id.substring(0, 6), playerX, playerY - 15);
          });
      }
      
      // IDã‹ã‚‰è‰²ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•° (index.htmlã‹ã‚‰æ‹å€Ÿ)
      function getColorFromId(id) {
        let hash = 0;
        for (let i = 0; i < id.length; i++) {
          hash = id.charCodeAt(i) + ((hash << 5) - hash);
        }
        const h = Math.abs(hash % 360);
        // HSLã‚’RGBã«å¤‰æ›ã™ã‚‹ç°¡æ˜“çš„ãªå‡¦ç†ï¼ˆP5.jsã¯RGBã®ãŸã‚ï¼‰
        // HSLã‹ã‚‰è‰²ç›¸(H)ã®ã¿ã‚’åˆ©ç”¨ã—ã€S=60%, L=65%ã‚’ä»®å®š
        return color(h, 60, 65, 360, 100, 100).levels; 
      }
      // P5.jsã®è‰²ãƒ¢ãƒ¼ãƒ‰ã‚’HSLã«è¨­å®š
      colorMode(HSL, 360, 100, 100);

    </script>
  </body>
</html>