<!DOCTYPE html>
<html>
Â  <head>
Â  Â  <meta charset="utf-8" />
Â  Â  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
Â  Â  <meta name="viewport" content="width=device-width, initial=" initial-scale="1" />
Â  Â  <title>ã‚¹ãƒãƒ›ã§å‹•ã3Dãƒœãƒ¼ãƒ«</title>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <style>
        body { margin: 0; background-color: black; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: sans-serif;
            z-index: 1000;
        }
        /* â˜…è¿½åŠ ï¼šæ³¨æ„æ›¸ãã®ã‚¹ã‚¿ã‚¤ãƒ«â˜… */
        #start-instruction {
            color: #FFD700; /* é‡‘è‰² */
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.5); 
            pointer-events: none; 
        }
        #clear-message {
            color: #4CAF50; 
            font-size: 72px;
            font-weight: bold;
            text-shadow: 4px 4px 8px black;
            margin-bottom: 20px;
            display: none;
        }
        #final-time {
            color: white;
            font-size: 48px;
            font-weight: normal;
            text-shadow: 2px 2px 4px black;
            display: none;
        }
        #replay-button {
            padding: 15px 30px;
            font-size: 24px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: none;
            pointer-events: auto; 
        }
    </style>
Â  </head>

Â  <body>
    <div id="info">
        <h1>ã‚¹ãƒãƒ›ã‹ã‚‰ã®ã‚»ãƒ³ã‚µæƒ…å ±ã‚’å—ä¿¡</h1>
        <div>ã‚ãªãŸã®ID: <span id="myid"></span></div>
        <button id="connect">ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹</button>
        <div id="start-instruction">
            <p>ã€éŠã³æ–¹ã€‘ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦ãƒœãƒ¼ãƒ«ã‚’å‹•ã‹ã—ã¦ã€é»„è‰²ã®ã‚´ãƒ¼ãƒ«ã¾ã§ã€æœ€é€Ÿã‚¿ã‚¤ãƒ ã‚’ç›®æŒ‡ãã†ï¼</p>
            <p>ã‚¹ã‚¿ãƒ¼ãƒˆå‰ã«ã‚¹ãƒãƒ›ã‚’åœ°é¢ã¨æ°´å¹³ã«ã—ã¦ãã ã•ã„ï¼</p>
        </div>
        <div>Time: <span id="game-time">0.00</span>s</div>
    </div>

    <div id="overlay">
        <div id="clear-message">ğŸ‰ CLEAR! ğŸ‰</div>
        <div id="final-time"></div>
        <button id="replay-button">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
    </div>
Â  Â  
Â  Â  <script>
Â  Â  Â  let socket = io.connect();

Â  Â  Â  let btn = document.querySelector("#connect");
Â  Â  Â  let replayBtn = document.querySelector("#replay-button");
      let instructionDiv = document.querySelector("#start-instruction"); // æ³¨æ„æ›¸ãè¦ç´ 

Â  Â  Â  let b = 0; 
Â  Â  Â  let g = 0; 
      let operatedById = null; 
      
      let startTime = 0;
      let elapsedTime = 0;
      let gameRunning = false; 
      let isCleared = false;
      let clearMessage = document.querySelector("#clear-message");
      let timeDisplay = document.querySelector("#game-time");
      let finalTimeDisplay = document.querySelector("#final-time");

Â  Â  Â  let myid = sessionStorage.getItem('clientId');
Â  Â  Â  if (!myid) {
Â  Â  Â  Â  myid = Math.random().toString(36).substring(2, 15);
Â  Â  Â  Â  sessionStorage.setItem('clientId', myid);
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  document.querySelector("#myid").innerHTML = myid;

      function startGame() {
          startTime = millis();
          gameRunning = true;
          isCleared = false;
          
          // UIã‚’ãƒªã‚»ãƒƒãƒˆ
          clearMessage.style.display = 'none';
          finalTimeDisplay.style.display = 'none';
          replayBtn.style.display = 'none';
          instructionDiv.style.display = 'none'; // â˜…ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«éè¡¨ç¤ºã«ã™ã‚‹â˜…
          document.querySelector("#overlay").style.pointerEvents = 'none';

          // ãƒœãƒ¼ãƒ«ã‚’åˆæœŸä½ç½®ã«æˆ»ã™
          x = INITIAL_X;
          y = INITIAL_Y;
          z_offset = 0;
          isFalling = false;
      }
      
Â  Â  Â  btn.addEventListener("click", function () {
        socket.emit("user connected", myid); 
Â  Â  Â  Â  socket.emit("join", "game");
Â  Â  Â  Â  btn.remove();
        startGame();
Â  Â  Â  });
      
      replayBtn.addEventListener("click", function() {
          startGame();
      });
Â  Â  
Â  Â    // ã‚¹ãƒãƒ›ã‹ã‚‰ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿å—ä¿¡ã¨IDãƒã‚§ãƒƒã‚¯
Â  Â  Â  socket.on("sensor", function (data) {
        if (!operatedById) {
            operatedById = data.id;
        }
        if (data.id === operatedById) {
            g = parseFloat(data.g);
            b = parseFloat(data.b);
        }
Â  Â  Â  });

Â  Â  Â  let x = 0;
Â  Â  Â  let y = 0;
      let z_offset = 0; 
      let isFalling = false; 

Â  Â  Â  let r = 40; 
Â  Â  Â  let speed = 0.1; 
Â  Â  Â  
      const VIRTUAL_BOARD_WIDTH = 600; 
      const VIRTUAL_BOARD_HEIGHT = 1600; 
      
      const segmentWidth = 100; 
      const segmentHeight = 150; 
      const shiftX = 150; 
      const START_SEGMENT_WIDTH = 300; 
      
      const courseSegments = [
          { x: 0, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight/2, w: START_SEGMENT_WIDTH, h: segmentHeight }, 
          { x: shiftX, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 1.5, w: segmentWidth + shiftX, h: segmentHeight }, 
          { x: 0, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 2.5, w: segmentWidth + shiftX, h: segmentHeight }, 
          { x: -shiftX, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 3.5, w: segmentWidth + shiftX, h: segmentHeight }, 
          { x: 0, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 4.5, w: segmentWidth + shiftX, h: segmentHeight }, 
          { x: shiftX, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 5.5, w: segmentWidth + shiftX, h: segmentHeight }, 
          { x: 0, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 6.5, w: segmentWidth + shiftX, h: segmentHeight }, 
          { x: -shiftX, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 7.5, w: segmentWidth + shiftX, h: segmentHeight }, 
      ];
      
      const GOAL_SEGMENT_INDEX = courseSegments.length - 1;

      const INITIAL_X = courseSegments[0].x;
      const INITIAL_Y = courseSegments[0].y;
      
      // ----------------------------

      function getOnSegmentIndex(ballX, ballY) {
          for (let i = 0; i < courseSegments.length; i++) {
              let segment = courseSegments[i];
              const halfW = segment.w / 2;
              const halfH = segment.h / 2;
              
              const segMinX = segment.x - halfW;
              const segMaxX = segment.x + halfW;
              const segMinY = segment.y - halfH;
              const segMaxY = segment.y + halfH;
              
              if (ballX >= segMinX && ballX <= segMaxX &&
                  ballY >= segMinY && ballY <= segMaxY) {
                  return i; 
              }
          }
          return -1; 
      }

Â  Â  Â  function setup() {
Â  Â  Â  Â  createCanvas(800, 800, WEBGL); 
Â  Â  Â  Â  camera(0, 800, 100, 0, 0, 0, 0, 1, 0); 
Â  Â  Â  Â  noStroke();
        x = INITIAL_X;
        y = INITIAL_Y;
Â  Â  Â  }

Â  Â  Â  function draw() {
Â  Â  Â  Â  background(0);
        
        // â˜…ä¿®æ­£ï¼šç’°å¢ƒå…‰ã¨æŒ‡å‘æ€§ãƒ©ã‚¤ãƒˆã‚’æ˜ã‚‹ãã™ã‚‹â˜…
Â  Â  Â  Â  ambientLight(150, 150, 150); // å…¨ä½“ã‚’æ˜ã‚‹ã
Â  Â  Â  Â  directionalLight(255, 255, 255, -1, -1, -1); // å½±ãŒå¼·ã™ããªã„ã‚ˆã†ã«
Â  Â  Â  Â  pointLight(20, 20, 100, 0, 0, 800);

        
        if (gameRunning && !isCleared) {
            elapsedTime = (millis() - startTime) / 1000;
            timeDisplay.innerHTML = elapsedTime.toFixed(2);
        }

        let current_g = (gameRunning && !isCleared) ? g : 0;
        let current_b = (gameRunning && !isCleared) ? b : 0;

Â  Â  Â  Â  // æ¿å…¨ä½“ã‚’å‚¾ã‘ã‚‹ (å›è»¢)
Â  Â  Â  Â  push();
Â  Â  Â  Â  rotateX((-PI * current_b) / 180);
Â  Â  Â  Â  rotateY((PI * current_g) / 180);
Â  Â  Â  Â  translate(0, 0, -50); 

        // ã‚³ãƒ¼ã‚¹ã®æç”»
        for (let i = 0; i < courseSegments.length; i++) {
            const segment = courseSegments[i];
            push();
            translate(segment.x, segment.y, 0);

            // â˜…ã‚´ãƒ¼ãƒ«ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®è‰²ã®å¤‰æ›´ï¼ˆé»„è‰²ï¼‰â˜…
            if (i === GOAL_SEGMENT_INDEX) {
                specularMaterial(255, 200, 0); // é»„è‰²/ã‚´ãƒ¼ãƒ«ãƒ‰
            } else {
                specularMaterial(50, 50, 150); // ä»–ã®è¶³å ´ã¯é’ç³»ã§çµ±ä¸€
            }
            
            box(segment.w, segment.h, 30); 
            pop();
        }
Â  Â  Â  Â  pop(); // æ¿å…¨ä½“ã®å›è»¢ã‚’ãƒªã‚»ãƒƒãƒˆ

Â  Â  Â  Â  // ãƒœãƒ¼ãƒ«ã®å‹•ã
Â  Â  Â  Â  push();
Â  Â  Â  Â  
        if (gameRunning && !isCleared) {
            let onSegmentIndex = getOnSegmentIndex(x, y);

            if (!isFalling) {
                // 1. é€šå¸¸æ™‚ã®ä½ç½®æ›´æ–°
        Â  Â  Â  Â  x = x + speed * current_g;
        Â  Â  Â  Â  y = y + speed * current_b;

                // 2. ã‚´ãƒ¼ãƒ«åˆ¤å®š
                if (onSegmentIndex === GOAL_SEGMENT_INDEX) {
                    isCleared = true;
                    // ã‚¯ãƒªã‚¢æ™‚ã®è¡¨ç¤ºæ›´æ–°
                    finalTimeDisplay.innerHTML = `Time: ${elapsedTime.toFixed(2)}s`;
                    clearMessage.style.display = 'block';
                    finalTimeDisplay.style.display = 'block';
                    replayBtn.style.display = 'block';
                    document.querySelector("#overlay").style.pointerEvents = 'auto'; 
                }

                // 3. ç©´è½ã¡åˆ¤å®š
                if (onSegmentIndex === -1) {
                    isFalling = true;
                }

            } else {
                // 4. è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­
                z_offset -= 10; 
                if (z_offset < -200) { 
                    x = INITIAL_X;
                    y = INITIAL_Y;
                    z_offset = 0;
                    isFalling = false;
                }
            }
        }
        
        // ãƒœãƒ¼ãƒ«ã®é«˜ã•ã‚’è¨ˆç®—ï¼ˆå‚¾ãã‚’è€ƒæ…®ï¼‰
        let tiltZ = -x * sin((PI * current_g) / 180) - y * sin((PI * current_b) / 180);

        translate(x, y, tiltZ + z_offset);
Â  Â  Â  Â  
Â  Â  Â  Â  specularMaterial(200);
Â  Â  Â  Â  sphere(r);
        
Â  Â  Â  Â  pop();
Â  Â  Â  }
Â  Â  </script>
Â  </body>
</html>