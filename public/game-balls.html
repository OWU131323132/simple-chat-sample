<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial=" initial-scale="1" />
		<title>ã‚¹ãƒãƒ›ã§å‹•ã3Dãƒœãƒ¼ãƒ«</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
		<style>
			body { margin: 0; background-color: black; }
			#info {
				position: absolute;
				top: 10px;
				left: 10px;
				color: white;
				font-family: sans-serif;
				z-index: 1000;
			}

			#start-instruction {
				color: #FFD700;
				font-size: 16px;
				font-weight: bold;
				margin-top: 10px;
			}
			#overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				display: flex;
				justify-content: center;
				align-items: center;
				flex-direction: column;
				z-index: 1000;
				background-color: rgba(0, 0, 0, 0.5); 
				pointer-events: none; 
			}
			#clear-message {
				color: #4CAF50; 
				font-size: 72px;
				font-weight: bold;
				text-shadow: 4px 4px 8px black;
				margin-bottom: 20px;
				display: none;
			}
			#final-time {
				color: white;
				font-size: 48px;
				font-weight: normal;
				text-shadow: 2px 2px 4px black;
				display: none;
			}
			#replay-button {
				padding: 15px 30px;
				font-size: 24px;
				cursor: pointer;
				background-color: #007BFF;
				color: white;
				border: none;
				border-radius: 8px;
				margin-top: 30px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
				display: none;
				pointer-events: auto; 
			}
		</style>
	</head>

	<body>
		<div id="info">
			<h1>ã‚¹ãƒãƒ›ã‹ã‚‰ã®ã‚»ãƒ³ã‚µæƒ…å ±ã‚’å—ä¿¡</h1>
			<div>ã‚ãªãŸã®ID: <span id="myid"></span></div>
			<button id="connect">ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹</button>
			<div id="start-instruction">
				<p>ã€éŠã³æ–¹ã€‘ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦ãƒœãƒ¼ãƒ«ã‚’å‹•ã‹ã—ã¦ã€é»„è‰²ã®ã‚´ãƒ¼ãƒ«ã¾ã§ã€æœ€é€Ÿã‚¿ã‚¤ãƒ ã‚’ç›®æŒ‡ãã†ï¼</p>
				<p>ã‚¹ã‚¿ãƒ¼ãƒˆå‰ã«ã‚¹ãƒãƒ›ã‚’åœ°é¢ã¨æ°´å¹³ã«ã—ã¦ãã ã•ã„ï¼</p>
			</div>
			<div>Time: <span id="game-time">0.00</span>s</div>
		</div>

		<div id="overlay">
			<div id="clear-message">ğŸ‰ CLEAR! ğŸ‰</div>
			<div id="final-time"></div>
			<button id="replay-button">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
		</div>

		<script>
			let socket = io.connect();

			let btn = document.querySelector("#connect");
			let replayBtn = document.querySelector("#replay-button");
			let instructionDiv = document.querySelector("#start-instruction");

			let b = 0; 
			let g = 0; 
			let operatedById = null; 
	
			let startTime = 0;
			let elapsedTime = 0;
			let gameRunning = false; 
			let isCleared = false;
			let clearMessage = document.querySelector("#clear-message");
			let timeDisplay = document.querySelector("#game-time");
			let finalTimeDisplay = document.querySelector("#final-time");

			let myid = sessionStorage.getItem('clientId');
			if (!myid) {
				myid = Math.random().toString(36).substring(2, 15);
				sessionStorage.setItem('clientId', myid);
			}

			document.querySelector("#myid").innerHTML = myid;

			function startGame() {
				startTime = millis();
				gameRunning = true;
				isCleared = false;
				
				
				clearMessage.style.display = 'none';
				finalTimeDisplay.style.display = 'none';
				replayBtn.style.display = 'none'; 
				instructionDiv.style.display = 'none'; 
				document.querySelector("#overlay").style.pointerEvents = 'none';

				
				x = INITIAL_X;
				y = INITIAL_Y;
				z_offset = 0;
				isFalling = false;
			}
	
			btn.addEventListener("click", function () {
				socket.emit("user connected", myid); 
				socket.emit("join", "game");
				btn.remove();
				startGame();
			});
	
			replayBtn.addEventListener("click", function() {
				startGame();
			});

			socket.on("sensor", function (data) {
				if (!operatedById) {
					operatedById = data.id;
				}
				if (data.id === operatedById) {
					g = parseFloat(data.g);
					b = parseFloat(data.b);
				}
			});

			let x = 0;
			let y = 0;
			let z_offset = 0; 
			let isFalling = false; 

			let r = 40; 
			let speed = 0.1; 
	
			const VIRTUAL_BOARD_WIDTH = 600; 
			const VIRTUAL_BOARD_HEIGHT = 1600; 
	
			const segmentWidth = 100; 
			const segmentHeight = 150; 
			const shiftX = 150; 
			const START_SEGMENT_WIDTH = 300; 
	
			const courseSegments = [
				{ x: 0, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight/2, w: START_SEGMENT_WIDTH, h: segmentHeight }, 
				{ x: shiftX, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 1.5, w: segmentWidth + shiftX, h: segmentHeight }, 
				{ x: 0, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 2.5, w: segmentWidth + shiftX, h: segmentHeight }, 
				{ x: -shiftX, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 3.5, w: segmentWidth + shiftX, h: segmentHeight }, 
				{ x: 0, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 4.5, w: segmentWidth + shiftX, h: segmentHeight }, 
				{ x: shiftX, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 5.5, w: segmentWidth + shiftX, h: segmentHeight }, 
				{ x: 0, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 6.5, w: segmentWidth + shiftX, h: segmentHeight }, 
				{ x: -shiftX, y: -(VIRTUAL_BOARD_HEIGHT/2) + segmentHeight * 7.5, w: segmentWidth + shiftX, h: segmentHeight }, 
			];
	
			const GOAL_SEGMENT_INDEX = courseSegments.length - 1;

			const INITIAL_X = courseSegments[0].x;
			const INITIAL_Y = courseSegments[0].y;
	
	
			function getOnSegmentIndex(ballX, ballY) {
				for (let i = 0; i < courseSegments.length; i++) {
					let segment = courseSegments[i];
					const halfW = segment.w / 2;
					const halfH = segment.h / 2;
		
					const segMinX = segment.x - halfW;
					const segMaxX = segment.x + halfW;
					const segMinY = segment.y - halfH;
					const segMaxY = segment.y + halfH;
		
					if (ballX >= segMinX && ballX <= segMaxX &&
						ballY >= segMinY && ballY <= segMaxY) {
						return i; 
					}
				}
				return -1; 
			}

			function setup() {
				createCanvas(800, 800, WEBGL); 
				camera(0, 800, 100, 0, 0, 0, 0, 1, 0); 
				noStroke();
				x = INITIAL_X;
				y = INITIAL_Y;
			}

			function draw() {
				background(0);
		
				
				ambientLight(150, 150, 150); 
				directionalLight(255, 255, 255, -1, -1, -1); 
				pointLight(20, 20, 100, 0, 0, 800);

		
				
				if (gameRunning && !isCleared) {
					elapsedTime = (millis() - startTime) / 1000;
					timeDisplay.innerHTML = elapsedTime.toFixed(2);
				}

				let current_g = (gameRunning && !isCleared) ? g : 0;
				let current_b = (gameRunning && !isCleared) ? b : 0;

				
				push();
				rotateX((-PI * current_b) / 180);
				rotateY((PI * current_g) / 180);
				translate(0, 0, -50); 

				
				for (let i = 0; i < courseSegments.length; i++) {
					const segment = courseSegments[i];
					push();
					translate(segment.x, segment.y, 0);

					
					if (i === GOAL_SEGMENT_INDEX) {
						specularMaterial(255, 200, 0); 
					} else {
						specularMaterial(50, 50, 150); 
					}
		
					box(segment.w, segment.h, 30); 
					pop();
				}
				pop(); 

				
				push();
		
				if (gameRunning && !isCleared) {
					let onSegmentIndex = getOnSegmentIndex(x, y);

					if (!isFalling) {
						
						x = x + speed * current_g;
						y = y + speed * current_b;

						
						if (onSegmentIndex === GOAL_SEGMENT_INDEX) {
							isCleared = true;
							
							finalTimeDisplay.innerHTML = `Time: ${elapsedTime.toFixed(2)}s`;
							clearMessage.style.display = 'block';
							finalTimeDisplay.style.display = 'block';
							replayBtn.style.display = 'block';
							document.querySelector("#overlay").style.pointerEvents = 'auto'; 
						}

						
						if (onSegmentIndex === -1) {
							isFalling = true;
						}

					} else {
						
						z_offset -= 10; 
						if (z_offset < -200) { 
							x = INITIAL_X;
							y = INITIAL_Y;
							z_offset = 0;
							isFalling = false;
						}
					}
				}
		
				
				let tiltZ = -x * sin((PI * current_g) / 180) - y * sin((PI * current_b) / 180);

				translate(x, y, tiltZ + z_offset);
		
				specularMaterial(200);
				sphere(r);
		
				pop();
			}
		</script>
	</body>
</html>